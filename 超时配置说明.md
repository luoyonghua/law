# 超时配置说明

## 问题描述

批量结构化提取接口处理时间较长，前端默认 30 秒超时导致请求被取消（canceled）。

## 解决方案

为耗时较长的接口设置更长的超时时间。

## 超时配置

### 1. 默认超时时间

**文件**: `src/utils/http/documentRequest.ts`

```typescript
const REQUEST_TIMEOUT = 30000 // 30 秒（默认）
```

适用于：
- 获取文档列表
- 批量上传
- 查询上传进度

### 2. 批量结构化提取

**文件**: `src/api/documents.ts`

```typescript
export function batchStructuredExtract(docIds: string[]) {
  return documentRequest.post({
    url: '/api/elements/batch-structured-extract',
    data: { doc_ids: docIds },
    timeout: 300000 // 5 分钟超时
  })
}
```

**原因**：
- AI 提取需要较长处理时间
- 每个文书约需 10-30 秒
- 批量处理多个文书时间累加

### 3. 文书比对

**文件**: `src/api/documents.ts`

```typescript
export function compareDocuments(docIds: string[], comparisonType: string = 'custom') {
  return documentRequest.post({
    url: '/api/comparison/compare',
    data: { doc_ids: docIds, comparison_type: comparisonType },
    timeout: 300000 // 5 分钟超时
  })
}
```

**原因**：
- 基于 LLM 的智能比对需要时间
- 多文书比对时间更长
- 需要生成详细的差异分析

## 超时时间对照表

| 接口 | 超时时间 | 说明 |
|------|---------|------|
| 获取文档列表 | 30 秒 | 快速查询 |
| 批量上传 | 30 秒 | 文件上传 |
| 查询上传进度 | 30 秒 | 状态查询 |
| 批量结构化提取 | **5 分钟** | AI 处理耗时 |
| 文书比对 | **5 分钟** | LLM 分析耗时 |

## 用户体验优化

### 1. 提示信息

在批量提取和文书比对对话框中添加了提示：

```vue
<el-alert
  title="提示：批量提取可能需要较长时间，请耐心等待"
  type="info"
>
  <template #default>
    <p>• 提取时间取决于文书数量和复杂度</p>
    <p>• 每个文书大约需要 10-30 秒</p>
    <p>• 请勿关闭此窗口或刷新页面</p>
  </template>
</el-alert>
```

### 2. 进度显示

- 显示进度条
- 显示当前处理状态
- 显示预计剩余时间

### 3. 防止误操作

- 处理中禁用关闭按钮
- 提示用户不要刷新页面
- 显示"处理中..."状态

## 技术实现

### Axios 超时配置

```typescript
// 方式1: 全局配置
const axiosInstance = axios.create({
  timeout: 30000 // 默认 30 秒
})

// 方式2: 单个请求配置（推荐）
axios.post(url, data, {
  timeout: 300000 // 5 分钟
})
```

### 超时处理

```typescript
try {
  const response = await batchStructuredExtract(docIds)
  // 处理成功
} catch (error) {
  if (error.code === 'ECONNABORTED') {
    ElMessage.error('请求超时，请稍后重试')
  } else {
    ElMessage.error('提取失败')
  }
}
```

## 最佳实践

### 1. 根据业务设置超时

- **快速查询**: 10-30 秒
- **文件上传**: 30-60 秒
- **AI 处理**: 3-5 分钟
- **批量操作**: 5-10 分钟

### 2. 提供用户反馈

- 显示进度条
- 显示预计时间
- 提供取消选项（可选）

### 3. 错误处理

- 区分超时错误和其他错误
- 提供重试选项
- 记录错误日志

### 4. 后端优化

- 考虑异步处理
- 提供进度查询接口
- 实现任务队列

## 异步处理方案（可选）

如果处理时间超过 5 分钟，建议改为异步处理：

### 1. 提交任务

```typescript
// 提交批量提取任务
const response = await submitBatchExtractTask(docIds)
const taskId = response.task_id
```

### 2. 轮询查询

```typescript
// 轮询查询任务状态
const timer = setInterval(async () => {
  const status = await getTaskStatus(taskId)
  if (status.completed) {
    clearInterval(timer)
    // 获取结果
    const results = await getTaskResults(taskId)
  }
}, 3000) // 每 3 秒查询一次
```

### 3. WebSocket 推送（更优）

```typescript
// 建立 WebSocket 连接
const ws = new WebSocket('wss://api.example.com/tasks')

// 监听任务完成
ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  if (data.task_id === taskId && data.status === 'completed') {
    // 处理结果
  }
}
```

## 验证方法

### 1. 测试超时配置

```bash
# 启动项目
pnpm dev

# 选择多个文书进行批量提取
# 观察请求是否在 5 分钟内完成
# 检查 Network 标签的请求状态
```

### 2. 检查点

- ✅ 请求不会在 30 秒后被取消
- ✅ 显示"处理中"状态
- ✅ 最终返回结果或超时错误
- ✅ 用户体验友好

## 常见问题

### Q1: 为什么不增加全局超时时间？

**A**: 不同接口的处理时间差异很大，全局设置会导致：
- 快速接口等待时间过长
- 无法针对性优化
- 不利于问题排查

### Q2: 5 分钟够用吗？

**A**: 根据业务需求调整：
- 少量文书（1-5个）：1-2 分钟
- 中等数量（5-10个）：3-5 分钟
- 大量文书（10+个）：考虑异步处理

### Q3: 如何处理超时错误？

**A**: 
```typescript
catch (error) {
  if (error.code === 'ECONNABORTED') {
    ElMessage.error('处理超时，请减少文书数量或稍后重试')
  }
}
```

### Q4: 能否取消正在处理的请求？

**A**: 可以使用 AbortController：
```typescript
const controller = new AbortController()

axios.post(url, data, {
  signal: controller.signal
})

// 取消请求
controller.abort()
```

## 性能建议

### 前端

1. **限制批量数量**: 建议每次不超过 10 个文书
2. **分批处理**: 大量文书分多次提取
3. **缓存结果**: 避免重复提取

### 后端

1. **优化算法**: 提高 AI 处理速度
2. **并行处理**: 多个文书并行提取
3. **异步队列**: 使用任务队列处理

## 监控建议

1. **记录处理时间**: 统计平均处理时长
2. **超时率监控**: 监控超时请求比例
3. **性能优化**: 根据数据优化超时配置

---

**更新时间**: 2026-02-06  
**状态**: ✅ 已配置  
**超时时间**: 批量提取和文书比对设置为 5 分钟
