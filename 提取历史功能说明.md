# 提取历史功能说明

## ✅ 功能实现

提取历史记录功能已完整实现，用户可以查看所有历史提取记录。

## 📋 功能特性

### 1. 历史记录列表

**文件**: `src/views/documents/history/index.vue`

**功能**:
- ✅ 分页显示历史记录
- ✅ 显示文件名、案件编号、文书类型
- ✅ 显示提取方法、处理时间
- ✅ 显示验证状态、创建时间
- ✅ 支持筛选（文件名、案件编号、文书类型）
- ✅ 支持刷新
- ✅ 查看详情
- ✅ 导出功能（预留）

### 2. 详情查看

**功能**:
- ✅ 显示记录基本信息
- ✅ 显示完整的结构化数据
- ✅ 被告人信息表格
- ✅ 指控罪名、事实概要
- ✅ 证据列表、法律依据
- ✅ 处理结果

### 3. 分页功能

**功能**:
- ✅ 支持分页查询
- ✅ 可选每页数量（10/20/50/100）
- ✅ 显示总记录数和总页数
- ✅ 快速跳转到指定页

## 🔌 API 接口

### 获取提取历史

**接口**: `GET /api/extraction/history`

**参数**:
```typescript
{
  page: number        // 页码，默认 1
  page_size: number   // 每页数量，默认 10
}
```

**返回**:
```typescript
{
  total: number           // 总记录数
  page: number            // 当前页码
  page_size: number       // 每页数量
  total_pages: number     // 总页数
  records: ExtractionHistoryRecord[]  // 记录列表
}
```

**记录结构**:
```typescript
interface ExtractionHistoryRecord {
  record_id: string              // 记录ID
  record_type: string            // 记录类型
  doc_id: string                 // 文档ID
  file_name: string              // 文件名
  doc_type: string               // 文书类型
  case_id: string                // 案件编号
  processing_time: number        // 处理时间（秒）
  extraction_method: string      // 提取方法
  created_at: string             // 创建时间
  structured_data: ExtractedData // 结构化数据
  is_verified: boolean           // 是否已验证
}
```

## 📊 界面展示

### 列表页面

| 列名 | 说明 | 宽度 |
|------|------|------|
| 文件名称 | 原始文件名 | 200px |
| 案件编号 | 案件ID | 180px |
| 文书类型 | 文书类型标签 | 120px |
| 提取方法 | AI 提取方法 | 150px |
| 处理时间 | 提取耗时（秒） | 120px |
| 验证状态 | 已验证/未验证 | 100px |
| 创建时间 | 提取时间 | 180px |
| 操作 | 查看详情、导出 | 200px |

### 筛选条件

- **文件名**: 模糊搜索
- **案件编号**: 模糊搜索
- **文书类型**: 下拉选择

### 详情对话框

- 记录基本信息（8个字段）
- 结构化数据完整展示
- 被告人信息表格
- 指控罪名标签
- 事实概要文本框
- 证据列表
- 法律依据标签
- 处理结果高亮显示

## 🎯 使用流程

### 1. 查看历史记录

```
进入"文书管理" → "提取历史"
    ↓
查看历史记录列表
    ↓
使用筛选条件过滤
    ↓
分页浏览记录
```

### 2. 查看详情

```
找到目标记录
    ↓
点击"查看详情"
    ↓
查看完整的结构化数据
    ↓
可选：导出记录
```

### 3. 筛选记录

```
输入筛选条件
    ↓
点击"搜索"
    ↓
查看筛选结果
    ↓
点击"重置"清空条件
```

## 🔧 技术实现

### 1. API 调用

```typescript
// 获取历史记录
export function fetchExtractionHistory(page: number = 1, pageSize: number = 10) {
  return documentRequest.get<Api.Documents.ExtractionHistoryResponse>({
    url: '/api/extraction/history',
    params: { page, page_size: pageSize }
  })
}
```

### 2. 分页处理

```typescript
const pagination = ref({
  page: 1,
  pageSize: 10,
  total: 0,
  totalPages: 0
})

// 页码变化
const handlePageChange = (page: number) => {
  pagination.value.page = page
  getHistoryRecords()
}

// 每页数量变化
const handleSizeChange = (size: number) => {
  pagination.value.pageSize = size
  pagination.value.page = 1
  getHistoryRecords()
}
```

### 3. 前端筛选

```typescript
const filteredRecords = computed(() => {
  return records.value.filter((record) => {
    if (searchForm.value.fileName && !record.file_name.includes(searchForm.value.fileName)) {
      return false
    }
    if (searchForm.value.caseId && !record.case_id.includes(searchForm.value.caseId)) {
      return false
    }
    if (searchForm.value.docType && record.doc_type !== searchForm.value.docType) {
      return false
    }
    return true
  })
})
```

## 📝 数据流转

```
用户访问历史页面
    ↓
调用 fetchExtractionHistory API
    ↓
GET https://law_cwd.app.xdo.icu/api/extraction/history?page=1&page_size=10
    ↓
后端返回历史记录
    ↓
前端展示列表
    ↓
用户筛选/分页
    ↓
更新显示
```

## ✨ 功能亮点

1. **完整记录**: 保存所有提取历史
2. **详细信息**: 包含提取方法、处理时间等
3. **灵活筛选**: 支持多条件筛选
4. **分页浏览**: 高效处理大量记录
5. **详情查看**: 完整展示结构化数据
6. **验证状态**: 标识记录是否已验证

## 🧪 测试步骤

### 1. 访问历史页面

```bash
# 启动项目
pnpm dev

# 登录系统
访问 http://localhost:3006

# 进入历史页面
文书管理 → 提取历史
```

### 2. 验证功能

- ✅ 列表正常显示
- ✅ 分页功能正常
- ✅ 筛选功能正常
- ✅ 详情查看正常
- ✅ 刷新功能正常

### 3. 检查 API

打开浏览器开发者工具 → Network：
- ✅ URL: `https://law_cwd.app.xdo.icu/api/extraction/history?page=1&page_size=10`
- ✅ 返回数据格式正确
- ✅ 分页参数正确传递

## 📊 与其他功能的关系

### 批量提取 → 提取历史

```
批量提取完成
    ↓
后端保存提取记录
    ↓
用户查看提取历史
    ↓
查看历史提取结果
```

### 提取历史 → 导出

```
查看历史记录
    ↓
选择需要的记录
    ↓
点击导出
    ↓
下载提取结果
```

## 🎨 界面优化

### 1. 状态标识

- **验证状态**: 
  - 已验证：绿色标签
  - 未验证：灰色标签

- **提取方法**:
  - Kimi AI：绿色标签
  - GPT：蓝色标签
  - Claude：紫色标签

### 2. 数据展示

- 处理时间：保留2位小数
- 创建时间：完整时间戳
- 文书类型：彩色标签
- 长文本：显示省略号

### 3. 交互优化

- 点击行查看详情
- 双击复制记录ID
- 右键菜单（可选）

## 📚 待完善功能

以下功能已预留接口：

1. **导出功能**: 导出单个或批量记录
2. **删除功能**: 删除历史记录
3. **验证功能**: 标记记录为已验证
4. **对比功能**: 对比不同版本的提取结果
5. **统计功能**: 提取成功率、平均处理时间等

## 🔄 数据更新

### 自动刷新

可以添加自动刷新功能：

```typescript
// 每30秒自动刷新
const autoRefresh = setInterval(() => {
  getHistoryRecords()
}, 30000)

// 组件卸载时清除
onUnmounted(() => {
  clearInterval(autoRefresh)
})
```

### 实时更新

可以使用 WebSocket 实现实时更新：

```typescript
// 监听新记录
ws.onmessage = (event) => {
  const newRecord = JSON.parse(event.data)
  records.value.unshift(newRecord)
}
```

## ✅ 实现完成

提取历史功能已完整实现，可以正常使用！

---

**实现时间**: 2026-02-06  
**状态**: ✅ 已完成  
**路由**: `/documents/history`
