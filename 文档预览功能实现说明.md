# 文档预览功能实现说明

## 概述
为文书列表页面添加了文档预览功能，点击"查看详情"按钮可以在对话框中预览文档原文。

## 实现的功能

### DocumentPreviewDialog.vue（文档预览对话框）

#### 功能特性
- **全屏对话框**：提供最大的预览空间
- **文档信息展示**：显示案件编号、文书类型、文件大小、创建时间
- **多格式支持**：
  - DOCX 文档预览（使用 docx-preview 库）
  - PDF 文档预览（使用 iframe）
  - 图片预览（JPG、JPEG、PNG、TIFF）
  - 不支持的格式显示下载提示
- **下载功能**：提供下载按钮，可直接下载文档
- **响应式布局**：自适应不同屏幕尺寸

#### 组件接口
```typescript
interface Props {
  modelValue: boolean                           // 对话框显示状态
  documentInfo: Api.Documents.DocumentInfo | null  // 文档信息
}
```

#### 预览效果
- **DOCX**：完整渲染文档内容，支持样式、表格、图片等
- **PDF**：使用浏览器内置 PDF 查看器
- **图片**：居中显示，支持缩放
- **其他格式**：显示文件信息和下载按钮

## 代码实现

### 1. 创建 DocumentPreviewDialog.vue 组件

**位置**：`src/views/documents/components/DocumentPreviewDialog.vue`

**核心功能**：
```typescript
// 判断文件类型
const isDocx = computed(() => {
  if (!props.documentInfo) return false
  return props.documentInfo.file_name.toLowerCase().endsWith('.docx')
})

// 监听对话框打开，加载预览
watch(() => props.modelValue, async (newVal) => {
  if (newVal && props.documentInfo && isDocx.value) {
    await nextTick()
    await loadDocxPreview(props.documentInfo.doc_id)
  }
})

// 加载 DOCX 预览
const loadDocxPreview = async (docId: string) => {
  // 使用 docx-preview 库渲染文档
  await renderAsync(blob, docxPreviewContainer.value, options)
}
```

### 2. 修改 list/index.vue

**导入组件**：
```typescript
import DocumentPreviewDialog from '../components/DocumentPreviewDialog.vue'
```

**添加状态**：
```typescript
const previewVisible = ref(false)
const currentDocument = ref<Api.Documents.DocumentInfo | null>(null)
```

**修改查看详情函数**：
```typescript
const handleViewDetail = (row: Api.Documents.DocumentInfo) => {
  currentDocument.value = row
  previewVisible.value = true
}
```

**添加对话框**：
```vue
<DocumentPreviewDialog 
  v-model="previewVisible" 
  :document-info="currentDocument" 
/>
```

## 用户体验流程

1. 用户在文书列表中点击某个文档的"查看详情"按钮
2. 打开全屏预览对话框
3. 显示文档基本信息（案件编号、文书类型等）
4. 根据文件类型自动加载预览：
   - DOCX：显示 loading，加载完成后渲染文档
   - PDF：直接在 iframe 中显示
   - 图片：直接显示图片
   - 其他：显示下载提示
5. 用户可以：
   - 滚动查看文档内容
   - 点击"下载文档"按钮下载
   - 点击"关闭"或 ESC 键关闭对话框

## 样式设计

### 布局结构
```
┌─────────────────────────────────────┐
│ 文档预览 - 文件名.docx          [X] │
├─────────────────────────────────────┤
│ 文档信息（案件编号、类型等）        │
│ [下载文档]                          │
├─────────────────────────────────────┤
│                                     │
│                                     │
│         文档预览区域                │
│                                     │
│                                     │
└─────────────────────────────────────┘
│              [关闭]                 │
└─────────────────────────────────────┘
```

### DOCX 预览样式
- 灰色背景（#525659）模拟 PDF 阅读器
- 白色文档容器，最大宽度 900px
- 阴影效果，增强立体感
- 自动调整内容宽度，适应容器

### 响应式设计
- 全屏模式，充分利用屏幕空间
- 文档内容自适应宽度
- 表格、图片等元素自动缩放

## 技术细节

### DOCX 渲染配置
```typescript
await renderAsync(blob, container, undefined, {
  className: 'docx-preview-content',
  inWrapper: true,
  ignoreWidth: true,        // 忽略原始宽度
  ignoreHeight: false,
  ignoreFonts: false,
  breakPages: true,         // 分页显示
  renderHeaders: true,      // 渲染页眉
  renderFooters: true,      // 渲染页脚
  renderFootnotes: true,    // 渲染脚注
  renderEndnotes: true      // 渲染尾注
})
```

### 文件大小格式化
```typescript
const formatFileSize = (size: number) => {
  if (size < 1024) return size + ' B'
  if (size < 1024 * 1024) return (size / 1024).toFixed(2) + ' KB'
  return (size / (1024 * 1024)).toFixed(2) + ' MB'
}
```

### 错误处理
- 文档加载失败时显示错误提示
- 不支持的文件类型显示友好提示
- 网络错误时提供重试机制

## 依赖项

- `docx-preview`：DOCX 文档渲染
- `@/api/documents`：文档下载和预览 API
- `@/store/modules/user`：用户认证信息
- Element Plus：UI 组件库

## 测试建议

### 功能测试
- [ ] 测试 DOCX 文件预览
- [ ] 测试 PDF 文件预览
- [ ] 测试图片文件预览
- [ ] 测试不支持的文件类型
- [ ] 测试下载功能
- [ ] 测试对话框打开/关闭

### 兼容性测试
- [ ] 测试不同浏览器（Chrome、Firefox、Edge）
- [ ] 测试不同文档大小（小文件、大文件）
- [ ] 测试复杂文档（包含表格、图片、样式）
- [ ] 测试中文文档

### 性能测试
- [ ] 测试大文件加载速度
- [ ] 测试多次打开关闭对话框
- [ ] 测试内存占用情况

### 异常测试
- [ ] 测试网络断开
- [ ] 测试文件不存在
- [ ] 测试权限不足
- [ ] 测试损坏的文件

## 相关文件

- ✅ `src/views/documents/components/DocumentPreviewDialog.vue` - 文档预览对话框组件
- ✅ `src/views/documents/list/index.vue` - 文书列表页面

## 后续优化建议

1. **搜索功能**：在预览中添加文本搜索功能
2. **打印功能**：支持直接打印文档
3. **全屏模式**：添加全屏预览按钮
4. **缩放控制**：添加放大/缩小按钮
5. **页面导航**：对于多页文档，添加页码导航
6. **批注功能**：支持在文档上添加批注
7. **对比模式**：支持两个文档并排对比
8. **历史记录**：记录最近查看的文档
