# 提取对话框预览问题排查

## 已修复的问题

### 1. 缺少 file_name 字段
**问题**：API 返回的 `ExtractionResult` 可能没有 `file_name` 字段，导致无法判断文件类型。

**解决方案**：在 `list/index.vue` 的 `handleExtract` 函数中，如果 API 返回的结果没有 `file_name`，则从原始的 `DocumentInfo` 中获取。

```typescript
if (!result.file_name) {
  result.file_name = row.file_name
}
```

### 2. 添加调试日志
**改进**：在 `ExtractDialog.vue` 中添加了详细的控制台日志，方便排查问题：
- 对话框打开时的数据状态
- 文件类型判断结果
- DOCX 加载过程
- 错误信息

### 3. 更好的错误处理
**改进**：
- 检查 `docxPreviewContainer` 是否存在
- 检查 `extractData` 和 `file_name` 是否存在
- 显示详细的错误信息

## 排查步骤

### 1. 打开浏览器控制台
按 F12 打开开发者工具，查看 Console 标签页。

### 2. 触发提取操作
点击文档列表中的"提取"按钮。

### 3. 查看控制台输出
应该看到类似以下的日志：

```
ExtractDialog opened with data: {doc_id: "xxx", file_name: "xxx.docx", ...}
File type - isDocx: true, isPdf: false, isImage: false
isDocx check: xxx.docx true
Loading DOCX preview for doc_id: xxx
Fetching document from: http://xxx/api/documents/xxx/download
Document blob loaded, size: 12345
DOCX rendered successfully
```

### 4. 常见问题

#### 问题 1：显示"该文件类型不支持在线预览"
**原因**：
- `file_name` 字段为空或 undefined
- 文件扩展名不是 .docx、.pdf 或图片格式

**解决**：
- 检查控制台日志，查看 `file_name` 的值
- 确认后端 API 返回了正确的 `file_name` 字段

#### 问题 2：DOCX 预览一直加载中
**原因**：
- 网络请求失败
- 文档下载 API 返回错误
- 认证 token 无效

**解决**：
- 检查控制台的网络请求（Network 标签页）
- 查看是否有 401 或 404 错误
- 确认 `VITE_DOCUMENT_API_URL` 环境变量配置正确

#### 问题 3：PDF 或图片不显示
**原因**：
- CORS 跨域问题
- URL 不正确

**解决**：
- 检查浏览器控制台的 CORS 错误
- 确认 `previewDocument` 函数返回的 URL 正确
- 测试直接在浏览器中打开预览 URL

## 启用调试面板

如果需要在页面上显示调试信息，可以修改 `ExtractDialog.vue` 模板：

将：
```vue
<div v-if="false" style="padding: 10px; background: #fff; border: 1px solid #ccc; margin: 10px;">
```

改为：
```vue
<div v-if="true" style="padding: 10px; background: #fff; border: 1px solid #ccc; margin: 10px;">
```

这将在预览区域顶部显示当前的状态信息。

## 后续优化建议

1. **后端 API 改进**：确保 `batch-structured-extract` API 返回完整的 `file_name` 字段
2. **加载状态优化**：添加骨架屏或更友好的加载提示
3. **错误提示优化**：根据不同的错误类型显示不同的提示信息
4. **性能优化**：对于大文件，考虑添加预览超时和取消功能
5. **缓存优化**：已加载的文档可以缓存，避免重复加载

## 测试清单

- [ ] DOCX 文件预览
- [ ] PDF 文件预览
- [ ] 图片文件预览
- [ ] 不支持的文件类型提示
- [ ] 下载按钮功能
- [ ] 导出按钮功能
- [ ] 网络错误处理
- [ ] 大文件加载
- [ ] 多次打开关闭对话框
- [ ] 切换不同文档
