# 批量结构化提取功能实现说明

## ✅ 功能实现

批量结构化提取功能已完整实现，包括：

### 1. 批量提取对话框组件

**文件**: `src/views/documents/components/BatchExtractDialog.vue`

**功能特性**:
- ✅ 显示已选择的文书列表
- ✅ 支持移除选中的文书
- ✅ 实时显示提取进度
- ✅ 多标签页展示提取结果
- ✅ 成功/失败状态标识
- ✅ 完整的结构化数据展示
- ✅ 支持重新提取
- ✅ 预留导出功能接口

### 2. 文书列表集成

**文件**: `src/views/documents/list/index.vue`

**更新内容**:
- ✅ 添加批量提取对话框组件
- ✅ 实现批量提取功能（选择多个文书）
- ✅ 实现单个提取功能（快捷操作）
- ✅ 调用真实后端 API

### 3. API 调用

**文件**: `src/api/documents.ts`

**接口**:
```typescript
export function batchStructuredExtract(docIds: string[])
```

**请求**:
- URL: `POST /api/elements/batch-structured-extract`
- Body: `{ doc_ids: ["doc_id1", "doc_id2", ...] }`

**返回**:
```typescript
{
  total: number
  success_count: number
  fail_count: number
  results: ExtractionResult[]
}
```

## 📋 使用流程

### 批量提取

1. 在文书列表中勾选多个文书
2. 点击"批量提取"按钮
3. 在弹出的对话框中确认选择的文书
4. 点击"开始提取"
5. 等待提取完成
6. 查看提取结果（多标签页展示）
7. 可选：导出结果或重新提取

### 单个提取

1. 在文书列表中找到目标文书
2. 点击该文书行的"结构化提取"按钮
3. 自动调用提取接口
4. 在弹出的对话框中查看提取结果

## 🎨 界面展示

### 提取配置界面
- 显示已选择的文书（带关闭按钮）
- "开始提取"按钮

### 提取进度界面
- 进度条显示百分比
- 显示"正在提取：X/Y"

### 提取结果界面
- 顶部提示：成功/失败数量
- 多标签页，每个文书一个标签
- 标签上显示成功/失败图标
- 成功的文书显示完整的结构化数据：
  - 基础信息（案号、案件名称、文书类型、处理时间）
  - 被告人信息表格
  - 指控罪名标签
  - 事实概要
  - 证据列表
  - 法律依据
  - 处理结果
  - 特定字段
- 失败的文书显示错误信息

## 📊 提取结果数据结构

```typescript
interface ExtractionResult {
  doc_id: string
  file_name: string
  success: boolean
  data: {
    案号: string
    案件名称: string
    文书类型: string
    被告人信息: DefendantInfo[]
    指控罪名: string[]
    事实概要: string
    证据列表: string[]
    法律依据: string[]
    处理结果: string
    特定字段: SpecificFields
  }
  processing_time: number
  extraction_id: string
}
```

## 🔧 技术实现

### 1. 组件通信

```typescript
// 父组件传递选中的文书
<BatchExtractDialog
  v-model="batchExtractVisible"
  :selected-docs="selectedDocs"
  @success="handleExtractSuccess"
/>

// 子组件接收并处理
const props = defineProps<{
  modelValue: boolean
  selectedDocs: Api.Documents.DocumentInfo[]
}>()
```

### 2. API 调用

```typescript
const handleExtract = async () => {
  const docIds = props.selectedDocs.map((doc) => doc.doc_id)
  const response = await batchStructuredExtract(docIds)
  results.value = response.results
}
```

### 3. 结果展示

```typescript
// 使用 el-tabs 展示多个结果
<el-tabs v-model="activeTab" type="border-card">
  <el-tab-pane
    v-for="(result, index) in results"
    :key="result.doc_id"
    :name="String(index)"
  >
    <!-- 结果内容 -->
  </el-tab-pane>
</el-tabs>
```

## ✨ 功能亮点

1. **批量处理**: 一次可以提取多个文书
2. **实时反馈**: 显示提取进度和状态
3. **结果对比**: 多标签页方便对比不同文书
4. **错误处理**: 清晰显示失败原因
5. **用户友好**: 可以移除不需要的文书
6. **数据完整**: 展示所有提取的字段

## 🧪 测试步骤

### 1. 批量提取测试

```bash
# 启动项目
pnpm dev

# 访问系统
http://localhost:3006

# 登录后进入文书列表
文书管理 → 文书列表

# 勾选多个文书
勾选 2-3 个文书

# 点击批量提取
点击"批量提取"按钮

# 确认并提取
点击"开始提取"

# 查看结果
等待提取完成，查看多标签页结果
```

### 2. 单个提取测试

```bash
# 在文书列表中
找到任意一个文书

# 点击结构化提取
点击该行的"结构化提取"按钮

# 查看结果
在弹出的对话框中查看提取结果
```

### 3. 验证要点

- ✅ API 请求 URL 正确：`https://law_cwd.app.xdo.icu/api/elements/batch-structured-extract`
- ✅ 请求体格式正确：`{ doc_ids: [...] }`
- ✅ 返回数据正确解析
- ✅ 界面正确显示提取结果
- ✅ 成功/失败状态正确标识
- ✅ 所有字段正确展示

## 📝 待完善功能

以下功能已预留接口，待后续开发：

1. **导出功能**: 导出提取结果为 PDF/Word
2. **编辑功能**: 手动编辑提取结果
3. **保存功能**: 保存提取结果到数据库
4. **历史记录**: 查看历史提取记录

## 🔄 与其他功能的关系

### 文书上传 → 结构化提取
```
上传文书 → 解析完成 → 选择文书 → 批量提取 → 查看结果
```

### 结构化提取 → 文书比对
```
提取结果 → 选择文书 → 文书比对 → 查看差异
```

## 📊 数据流转

```
用户选择文书
    ↓
点击批量提取
    ↓
BatchExtractDialog 组件
    ↓
调用 batchStructuredExtract API
    ↓
POST https://law_cwd.app.xdo.icu/api/elements/batch-structured-extract
    ↓
后端处理（AI 提取）
    ↓
返回提取结果
    ↓
组件展示结果
    ↓
用户查看/导出
```

## ✅ 实现完成

批量结构化提取功能已完整实现，可以正常使用！

---

**实现时间**: 2026-02-06  
**状态**: ✅ 已完成  
**测试状态**: ⏳ 待测试
