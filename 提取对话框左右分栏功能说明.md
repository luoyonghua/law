# 提取对话框左右分栏功能实现说明

## 概述
将文书列表页面的提取对话框（ExtractDialog.vue）改造为左右分栏布局，左侧显示原始文档预览，右侧显示提取的结构化要素，并实现点击要素高亮定位功能。

## 实现时间
2026-02-07

## 修改文件
- `src/views/documents/components/ExtractDialog.vue`

## 功能特性

### 1. 左右分栏布局
- **左侧面板（50%）**：显示原始文档预览
  - 支持 DOCX、PDF、图片格式预览
  - 提供下载和新窗口打开按钮
  - DOCX 使用 docx-preview 库渲染
  - PDF 使用 iframe 预览
  - 图片直接显示

- **右侧面板（50%）**：显示提取的结构化要素
  - 基本信息（文件名、处理时间）
  - 案件信息（案号、案件名称、文书类型）
  - 被告人信息表格
  - 指控罪名标签
  - 事实概要
  - 证据列表
  - 法律依据
  - 处理结果
  - 特定字段

### 2. 点击高亮定位功能
- 右侧所有可点击要素添加了 `clickable-text` 或 `clickable-tag` 类
- 点击任意要素后，在左侧文档中搜索并高亮对应内容
- 主要高亮：黄色背景 + 加粗 + 阴影效果
- 次要高亮：浅黄色背景
- 自动滚动到高亮位置

### 3. 文档预览优化
- 使用 `ignoreWidth: true` 让文档适应容器宽度
- 渲染后手动调整 `.docx-wrapper` 和 `section` 的宽度为 100%
- 确保文档内容完整显示，不会被截断

## 技术实现

### 核心函数

#### 1. loadDocxPreview
```typescript
const loadDocxPreview = async (docId: string) => {
  // 获取文档 blob
  const response = await fetch(`${VITE_DOCUMENT_API_URL}/api/documents/${docId}/download`)
  const blob = await response.blob()
  
  // 使用 docx-preview 渲染
  await renderAsync(blob, docxPreviewContainer.value, undefined, {
    ignoreWidth: true,
    // ... 其他配置
  })
  
  // 调整宽度
  const docxWrapper = docxPreviewContainer.value.querySelector('.docx-wrapper')
  docxWrapper.style.width = '100%'
}
```

#### 2. handleElementClick
```typescript
const handleElementClick = (value: any) => {
  // 将值转换为关键词
  let keyword = typeof value === 'string' ? value : String(value)
  
  // 在文档中搜索并高亮
  searchAndHighlightInDocument(keyword)
}
```

#### 3. searchAndHighlightInDocument
```typescript
const searchAndHighlightInDocument = (keyword: string) => {
  clearHighlight()
  
  const contentElement = docxPreviewContainer.value.querySelector('.docx-preview-content')
  const found = searchTextInElement(contentElement, keyword)
  
  if (!found) {
    ElMessage.warning(`未在文档中找到"${keyword}"`)
  }
}
```

#### 4. highlightText
```typescript
const highlightText = (textNode: Text, keyword: string, index: number, isPrimary: boolean) => {
  // 创建高亮元素
  const highlight = document.createElement('span')
  highlight.className = isPrimary ? 'keyword-highlight primary' : 'keyword-highlight'
  highlight.style.cssText = isPrimary 
    ? 'background-color: #ff0; padding: 2px 4px; border-radius: 2px; font-weight: bold; box-shadow: 0 0 8px rgba(255, 255, 0, 0.6);'
    : 'background-color: #ffeb3b; padding: 2px 4px; border-radius: 2px;'
  
  // 替换文本节点
  parent.replaceChild(fragment, textNode)
}
```

## 样式说明

### 布局样式
```scss
.extract-container-split {
  display: flex;
  height: calc(100vh - 120px);
  gap: 16px;

  .left-panel {
    flex: 0 0 50%;  // 固定 50% 宽度
  }

  .right-panel {
    flex: 0 0 50%;  // 固定 50% 宽度
  }
}
```

### DOCX 预览样式
```scss
.docx-preview-wrapper {
  background-color: #525659;  // 深灰色背景
  padding: 20px 10px;

  .docx-container {
    background-color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
  }
}
```

### 可点击元素样式
```scss
.clickable-text {
  cursor: pointer;
  transition: all 0.2s;
  
  &:hover {
    color: #409eff;
    text-decoration: underline;
  }
}

.clickable-tag {
  cursor: pointer;
  transition: all 0.2s;
  
  &:hover {
    opacity: 0.8;
    transform: translateY(-1px);
  }
}
```

## 使用方式

### 在文书列表页面调用
```vue
<template>
  <ExtractDialog v-model="extractVisible" :extract-data="extractData" />
</template>

<script setup lang="ts">
import ExtractDialog from '../components/ExtractDialog.vue'

const extractVisible = ref(false)
const extractData = ref<Api.Documents.ExtractionResult | null>(null)

// 单个提取
const handleExtract = async (row: Api.Documents.DocumentInfo) => {
  const response = await batchStructuredExtract([row.doc_id])
  if (response.results && response.results.length > 0) {
    extractData.value = response.results[0]
    extractVisible.value = true
  }
}
</script>
```

## 参考实现
本功能参考了以下页面的实现：
- `src/views/documents/history/index.vue` - 提取历史页面的左右分栏布局
- `src/views/documents/components/ReviewDialog.vue` - 文书审查对话框的高亮定位功能
- `src/views/documents/components/CompareDialog.vue` - 文书对比对话框的三栏布局

## 注意事项
1. 确保已安装 `docx-preview` 依赖包
2. 文档预览需要正确的 API 地址和认证 token
3. 高亮功能仅在 DOCX 文档中有效
4. 关键词长度至少为 2 个字符才会触发搜索
5. 如果文档中找不到关键词，会显示警告提示

## 测试建议
1. 测试不同文件格式的预览（DOCX、PDF、图片）
2. 测试点击不同类型的要素（文本、标签、列表项）
3. 测试高亮定位和滚动功能
4. 测试下载和新窗口打开功能
5. 测试在不同屏幕尺寸下的显示效果

## 后续优化建议
1. 支持 PDF 文档的高亮定位功能
2. 支持多个关键词同时高亮
3. 添加高亮导航功能（上一个/下一个）
4. 优化大文档的加载性能
5. 添加文档缩放功能
