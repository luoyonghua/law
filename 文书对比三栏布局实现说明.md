# 文书对比三栏布局实现说明

## 功能概述

将文书对比功能从原来的单栏结果展示改为三栏布局：
- **左栏**：显示文档A的原始内容
- **中栏**：显示文档B的原始内容
- **右栏**：显示详细的对比结果

## 主要改进

### 1. 布局结构

采用 Flexbox 三栏等宽布局：
```scss
.three-column-layout {
  display: flex;
  height: calc(100vh - 180px);
  gap: 1px;
  
  .column {
    flex: 1;
    
    &.left-column,
    &.middle-column {
      flex: 0 0 33%;  // 左中各占33%
    }
    
    &.right-column {
      flex: 0 0 34%;  // 右侧占34%
    }
  }
}
```

### 2. 文档预览功能

#### 支持的文件类型
- **DOCX**: 使用 `docx-preview` 库渲染
- **PDF**: 使用 iframe 直接预览
- **图片**: JPG、JPEG、PNG、TIFF 等格式直接显示
- **其他**: 显示不支持预览提示

#### DOCX 预览实现
```typescript
const loadDocxPreview = async (docId: string, container: HTMLElement, isDocA: boolean) => {
  const loadingRef = isDocA ? isLoadingDocA : isLoadingDocB
  loadingRef.value = true
  
  try {
    // 获取文档 blob（携带认证信息）
    const response = await fetch(`${VITE_DOCUMENT_API_URL}/api/documents/${docId}/download`, {
      headers: {
        'Authorization': userStore.accessToken || ''
      }
    })
    
    const blob = await response.blob()
    container.innerHTML = ''
    
    // 使用 docx-preview 渲染
    await renderAsync(blob, container, undefined, {
      className: 'docx-preview-content',
      inWrapper: true,
      // ... 其他配置
    })
  } catch (error) {
    ElMessage.error('文档预览加载失败')
  } finally {
    loadingRef.value = false
  }
}
```

### 3. 交互式高亮功能

点击右侧对比结果中的差异内容，可以在左侧或中侧对应的文档中高亮显示该内容。

#### 实现原理
```typescript
// 点击差异文本时触发
const highlightInDoc = (docType: 'A' | 'B', keyword: string) => {
  const container = docType === 'A' ? docAPreviewContainer.value : docBPreviewContainer.value
  
  // 清除之前的高亮
  clearHighlight(docType)
  
  // 搜索并高亮关键词
  const found = searchTextInElement(contentElement, keyword, currentHighlight)
  
  if (found) {
    // 滚动到高亮位置
    highlightElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
  }
}
```

#### 高亮样式
- **主要高亮**：黄色背景 + 加粗 + 阴影效果
- **次要高亮**：浅黄色背景
- **自动滚动**：高亮后自动滚动到可视区域中心

### 4. 模板结构

```vue
<div class="three-column-layout">
  <!-- 左栏：文档A -->
  <div class="column left-column">
    <div class="column-header">
      <h3>{{ selectedDocs[0]?.file_name }}</h3>
      <el-button @click="handleDownloadDoc(selectedDocs[0])">下载</el-button>
    </div>
    <div class="document-preview">
      <!-- DOCX/PDF/图片预览 -->
    </div>
  </div>

  <!-- 中栏：文档B -->
  <div class="column middle-column">
    <!-- 类似左栏结构 -->
  </div>

  <!-- 右栏：对比结果 -->
  <div class="column right-column">
    <div class="column-header">
      <h3>对比结果</h3>
      <el-button @click="handleExport">导出报告</el-button>
    </div>
    <div class="comparison-results">
      <el-scrollbar>
        <!-- 概览信息 -->
        <!-- 比对总结 -->
        <!-- 主要风险 -->
        <!-- 差异详情（可点击高亮） -->
        <!-- 处理建议 -->
      </el-scrollbar>
    </div>
  </div>
</div>
```

### 5. 差异详情交互

```vue
<div class="diff-section">
  <h4>文档A内容：</h4>
  <div 
    class="diff-text doc-a clickable-text" 
    @click="highlightInDoc('A', diff.text_in_doc_A)"
  >
    {{ diff.text_in_doc_A }}
  </div>
</div>

<div class="diff-section">
  <h4>文档B内容：</h4>
  <div 
    class="diff-text doc-b clickable-text" 
    @click="highlightInDoc('B', diff.text_in_doc_B)"
  >
    {{ diff.text_in_doc_B }}
  </div>
</div>
```

## 样式设计

### 1. 三栏分隔
使用 1px 的间隙和不同背景色实现视觉分隔：
```scss
.three-column-layout {
  gap: 1px;
  background-color: #e4e7ed;  // 间隙颜色
  
  .column {
    background-color: white;   // 栏目背景
  }
}
```

### 2. 文档预览样式
模拟 Word 界面：
```scss
.docx-preview-wrapper {
  background-color: #525659;  // 深灰色背景
  padding: 20px;
  
  .docx-container {
    background-color: white;   // 白色文档区域
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
  }
}
```

### 3. 可点击元素样式
```scss
.clickable-text {
  cursor: pointer;
  transition: all 0.2s;
  
  &:hover {
    color: #409eff;
    transform: translateX(2px);
  }
}
```

### 4. 差异文本样式
```scss
.diff-text {
  &.doc-a {
    background-color: #fef0f0;  // 浅红色
    border-left: 3px solid #f56c6c;
  }
  
  &.doc-b {
    background-color: #f0f9ff;  // 浅蓝色
    border-left: 3px solid #409eff;
  }
}
```

## 功能特点

### 1. 并排对比
- 左中两栏并排显示原始文档
- 方便直观地对比两份文档的内容
- 支持同步滚动（可选功能）

### 2. 交互式导航
- 点击右侧差异项，左侧文档自动定位并高亮
- 支持在文档中搜索和高亮多个匹配项
- 自动滚动到高亮位置

### 3. 完整的对比结果
- 相似度统计
- 差异项数量
- 风险等级分类
- 详细的差异分析
- 处理建议

### 4. 响应式设计
- 全屏对话框，充分利用屏幕空间
- 三栏等宽布局，平衡显示
- 独立滚动，互不干扰

## 使用流程

1. **选择文档**：在文档列表中选择2份文档
2. **开始比对**：点击"开始比对"按钮
3. **查看结果**：
   - 左中栏自动加载并显示原始文档
   - 右栏显示详细的对比结果
4. **交互导航**：
   - 点击右侧差异项中的文本
   - 左侧对应文档自动定位并高亮
5. **导出报告**：点击"导出报告"按钮（开发中）

## 技术栈

- **Vue 3**: 组合式 API
- **Element Plus**: UI 组件库
- **docx-preview**: DOCX 文件渲染
- **Fetch API**: 文档下载（支持认证）
- **TreeWalker API**: 文本搜索和高亮

## 注意事项

1. **文件大小限制**：大文件可能加载较慢，建议添加进度提示
2. **浏览器兼容性**：需要现代浏览器支持（Chrome、Firefox、Edge）
3. **认证要求**：文档下载需要携带 Authorization token
4. **内存占用**：同时加载两份文档可能占用较多内存
5. **样式还原**：复杂格式的 DOCX 可能无法完全还原

## 后续优化建议

1. **同步滚动**：左中两栏支持同步滚动
2. **缩放控制**：添加文档缩放功能
3. **搜索功能**：在文档中搜索关键词
4. **打印功能**：支持打印对比报告
5. **导出功能**：导出 PDF 或 Word 格式的对比报告
6. **性能优化**：大文件懒加载、虚拟滚动
7. **多文档对比**：支持3份以上文档的对比

## 相关文件

- `src/views/documents/components/CompareDialog.vue` - 文书对比组件
- `src/api/documents.ts` - 文档 API
- `DOCX预览功能实现说明.md` - DOCX 预览功能说明
