# 超时问题修复总结

## 🐛 问题

**症状**: 批量结构化提取接口处理时间较长，前端 30 秒后请求被取消（canceled）

**影响**: 
- 用户无法完成批量提取
- 文书比对也可能超时
- 用户体验差

## ✅ 解决方案

### 1. 增加超时时间

**文件**: `src/api/documents.ts`

为耗时较长的接口设置 5 分钟超时：

```typescript
// 批量结构化提取
export function batchStructuredExtract(docIds: string[]) {
  return documentRequest.post({
    url: '/api/elements/batch-structured-extract',
    data: { doc_ids: docIds },
    timeout: 300000 // 5 分钟超时（原来继承默认 30 秒）
  })
}

// 文书比对
export function compareDocuments(docIds: string[], comparisonType: string = 'custom') {
  return documentRequest.post({
    url: '/api/comparison/compare',
    data: { doc_ids: docIds, comparison_type: comparisonType },
    timeout: 300000 // 5 分钟超时
  })
}
```

### 2. 添加用户提示

**文件**: `src/views/documents/components/BatchExtractDialog.vue`

```vue
<el-alert
  title="提示：批量提取可能需要较长时间，请耐心等待"
  type="info"
>
  <template #default>
    <p>• 提取时间取决于文书数量和复杂度</p>
    <p>• 每个文书大约需要 10-30 秒</p>
    <p>• 请勿关闭此窗口或刷新页面</p>
  </template>
</el-alert>
```

**文件**: `src/views/documents/components/CompareDialog.vue`

```vue
<el-alert
  title="提示：文书比对可能需要较长时间，请耐心等待"
  type="info"
>
  <template #default>
    <p>• 比对时间取决于文书数量和复杂度</p>
    <p>• 基于 AI 的智能比对需要一定时间</p>
    <p>• 请勿关闭此窗口或刷新页面</p>
  </template>
</el-alert>
```

## 📊 超时配置对照

| 接口 | 原超时 | 新超时 | 原因 |
|------|--------|--------|------|
| 获取文档列表 | 30秒 | 30秒 | 快速查询 |
| 批量上传 | 30秒 | 30秒 | 文件上传 |
| 查询进度 | 30秒 | 30秒 | 状态查询 |
| **批量提取** | **30秒** | **5分钟** | **AI 处理耗时** |
| **文书比对** | **30秒** | **5分钟** | **LLM 分析耗时** |

## 🎯 修改文件

1. ✅ `src/api/documents.ts` - 增加超时配置
2. ✅ `src/views/documents/components/BatchExtractDialog.vue` - 添加提示
3. ✅ `src/views/documents/components/CompareDialog.vue` - 添加提示

## 🧪 验证方法

### 1. 批量提取测试

```bash
# 启动项目
pnpm dev

# 选择多个文书
勾选 3-5 个文书

# 点击批量提取
观察是否在 5 分钟内完成

# 检查 Network
- 请求不应在 30 秒后被取消
- 应该等待直到完成或 5 分钟超时
```

### 2. 文书比对测试

```bash
# 选择多个文书
勾选 2-3 个文书

# 点击文书比对
观察是否在 5 分钟内完成

# 检查结果
- 应该返回完整的比对结果
- 不应该出现 canceled 错误
```

### 3. 检查点

- ✅ 请求不会在 30 秒后被取消
- ✅ 显示友好的等待提示
- ✅ 进度条正常显示
- ✅ 最终返回结果或超时错误（5分钟）
- ✅ 用户知道需要等待

## 💡 用户体验改进

### 修复前
```
用户点击批量提取
    ↓
等待 30 秒
    ↓
请求被取消 ❌
    ↓
用户困惑：为什么失败？
```

### 修复后
```
用户点击批量提取
    ↓
看到提示：可能需要较长时间
    ↓
显示进度条
    ↓
等待最多 5 分钟
    ↓
返回结果 ✅
    ↓
用户满意
```

## 📝 技术说明

### Axios 超时机制

```typescript
// 全局超时（默认）
const axiosInstance = axios.create({
  timeout: 30000 // 30 秒
})

// 单个请求超时（覆盖全局）
axios.post(url, data, {
  timeout: 300000 // 5 分钟，覆盖全局配置
})
```

### 超时错误处理

```typescript
try {
  const response = await batchStructuredExtract(docIds)
  // 成功
} catch (error) {
  if (error.code === 'ECONNABORTED') {
    // 超时错误
    ElMessage.error('处理超时，请稍后重试')
  } else {
    // 其他错误
    ElMessage.error('提取失败')
  }
}
```

## 🚀 性能建议

### 前端优化

1. **限制批量数量**
   - 建议每次不超过 10 个文书
   - 大量文书分批处理

2. **显示预计时间**
   ```typescript
   const estimatedTime = docIds.length * 20 // 每个文书约 20 秒
   ```

3. **提供取消选项**（可选）
   ```typescript
   const controller = new AbortController()
   // 用户可以取消请求
   ```

### 后端优化

1. **异步处理**
   - 提交任务返回 task_id
   - 前端轮询查询进度

2. **并行处理**
   - 多个文书并行提取
   - 提高处理速度

3. **缓存机制**
   - 缓存已提取的结果
   - 避免重复处理

## 📚 相关文档

- **详细配置**: `超时配置说明.md`
- **API 配置**: `API配置说明.md`
- **验证清单**: `验证清单.md`

## ✅ 修复完成

超时问题已修复，批量提取和文书比对现在可以正常完成了！

---

**修复时间**: 2026-02-06  
**修复内容**: 
- 批量提取超时时间：30秒 → 5分钟
- 文书比对超时时间：30秒 → 5分钟
- 添加用户友好提示

**状态**: ✅ 已完成
