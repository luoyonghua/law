# 文书审查功能实现说明

## 功能概述

实现基于 AI 的智能文书审查功能，自动检测文书中的问题并提供修改建议。

## API 接口

### 批量审查接口

**接口地址**: `POST /api/review/batch-review`

**请求参数**:
```json
{
  "doc_ids": ["doc_9443ee6efcf1"],
  "include_elements": true
}
```

**响应数据**:
```json
{
  "code": 200,
  "msg": "批量审查完成，成功 1 个，失败 0 个",
  "data": {
    "batch_id": "batch_20260206_192919",
    "total_documents": 1,
    "successful_reviews": 1,
    "failed_reviews": 0,
    "results": [
      {
        "doc_id": "doc_9443ee6efcf1",
        "file_name": "01_起诉书_样本.docx",
        "success": true,
        "doc_type": "起诉书",
        "compliance_score": 0.0,
        "total_issues": 15,
        "issues": [...],
        "recommendations": [...]
      }
    ],
    "batch_time": "2026-02-06T19:29:19.897811"
  }
}
```

## 数据结构

### 审查问题 (ReviewIssue)
```typescript
interface ReviewIssue {
  category: string        // 问题类别
  severity: string        // 严重程度：严重、中等、轻微
  description: string     // 问题描述
  location: string        // 问题位置
  suggestion: string      // 修改建议
  legal_basis: string     // 法律依据
}
```

### 审查建议 (ReviewRecommendation)
```typescript
interface ReviewRecommendation {
  priority: number        // 优先级
  category: string        // 类别
  severity: string        // 严重程度
  recommendation: string  // 建议内容
  legal_basis: string     // 法律依据
  urgency: string         // 紧急程度
}
```

### 审查结果 (ReviewResult)
```typescript
interface ReviewResult {
  doc_id: string
  file_name: string
  success: boolean
  doc_type: string
  compliance_score: number      // 合规评分
  total_issues: number          // 问题总数
  issues: ReviewIssue[]         // 问题列表
  summary: string               // 总结
  recommendations: ReviewRecommendation[]  // 建议列表
  error?: string
}
```

## 功能特点

### 1. 左右分栏布局

- **左栏（45%）**: 显示原始文档
  - 支持 DOCX、PDF、图片预览
  - 可点击问题位置高亮显示
  
- **右栏（55%）**: 显示审查结果
  - 合规评分统计
  - 问题详情列表
  - 处理建议

### 2. 问题分类

支持多种问题类别：
- 法律术语规范性校验
- 必填项目完整性检测
- 法律引用准确性校验
- 事实认定证据充分性审查
- 证据清单完整性检测
- 程序期限准确性校验
- 当事人信息准确性校验
- 量刑情节完整性检测
- 文书格式规范
- 构成要件分析
- 证据充分性

### 3. 严重程度分级

- **严重**: 红色标签，影响文书合法性
- **中等**: 橙色标签，需要注意的问题
- **轻微**: 蓝色标签，格式或细节问题

### 4. 交互式高亮

点击右侧问题的"位置"字段，左侧文档会自动：
- 搜索并定位到对应位置
- 高亮显示相关内容
- 自动滚动到可视区域中心

### 5. 问题筛选

支持按严重程度筛选：
- 全部
- 严重
- 中等
- 轻微

### 6. 多文档审查

- 支持批量选择多份文档
- 可在下拉菜单中切换查看不同文档的审查结果
- 切换文档时自动加载对应的预览

### 7. 处理建议

按优先级排序的处理建议：
- 优先级标识
- 紧急程度标签
- 详细的修改建议
- 法律依据说明

## 使用流程

### 1. 选择文档

在文档列表页面：
- 勾选一份或多份文档
- 点击"文书审查"按钮

或者：
- 点击单个文档的"文书审查"按钮

### 2. 配置审查选项

- 查看已选择的文档列表
- 选择是否包含要素提取
- 点击"开始审查"

### 3. 查看审查结果

#### 概览信息
- 合规评分
- 问题总数
- 严重问题数量

#### 问题详情
- 展开/折叠问题项
- 查看问题描述、位置、建议、法律依据
- 点击位置在左侧文档中高亮

#### 处理建议
- 按优先级查看建议
- 了解紧急程度
- 参考法律依据

### 4. 导出报告

点击"导出报告"按钮（开发中）

## 界面设计

### 配置页面
```
┌─────────────────────────────────────┐
│ 提示：文书审查可能需要较长时间      │
├─────────────────────────────────────┤
│ 已选择文书 (2)                      │
│ [文档1.docx] [文档2.docx]           │
├─────────────────────────────────────┤
│ 审查选项                            │
│ ☑ 包含要素提取                      │
└─────────────────────────────────────┘
```

### 结果页面
```
┌──────────────────┬──────────────────────┐
│  原始文档        │  审查结果            │
│                  │                      │
│  [文档预览]      │  ┌─────────────────┐ │
│                  │  │ 合规评分: 85%   │ │
│                  │  │ 问题总数: 15    │ │
│                  │  │ 严重问题: 10    │ │
│                  │  └─────────────────┘ │
│                  │                      │
│                  │  问题详情            │
│                  │  [严重] 法律术语... │
│                  │  [中等] 证据充分... │
│                  │                      │
│                  │  处理建议            │
│                  │  1. [紧急] ...      │
│                  │  2. [重要] ...      │
└──────────────────┴──────────────────────┘
```

## 样式设计

### 问题项样式
```scss
.issue-title {
  display: flex;
  align-items: center;
  gap: 10px;
  
  .issue-category {
    font-size: 13px;
    font-weight: 500;
  }
}
```

### 位置高亮样式
```scss
.issue-location {
  padding: 10px;
  background-color: #f0f9ff;
  border-left: 3px solid #409eff;
  cursor: pointer;
  
  &:hover {
    opacity: 0.8;
    transform: translateX(2px);
  }
}
```

### 建议项样式
```scss
.recommendation-item {
  &.urgency-紧急 {
    border-left: 3px solid #f56c6c;
  }
  
  &.urgency-重要 {
    border-left: 3px solid #e6a23c;
  }
}
```

## 技术实现

### 1. API 调用
```typescript
export function batchReviewDocuments(
  docIds: string[], 
  includeElements: boolean = true
) {
  return documentRequest.post<Api.Documents.BatchReviewResponse>({
    url: '/api/review/batch-review',
    data: { doc_ids: docIds, include_elements: includeElements },
    timeout: 300000 // 5 分钟超时
  })
}
```

### 2. 文档预览
复用 DOCX 预览功能，支持：
- DOCX 文件渲染
- PDF 文件预览
- 图片显示

### 3. 高亮定位
```typescript
const highlightInDoc = (keyword: string) => {
  clearHighlight()
  const found = searchTextInElement(contentElement, keyword)
  if (found) {
    currentHighlightedElement.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    })
  }
}
```

### 4. 问题筛选
```typescript
const filteredIssues = computed(() => {
  if (severityFilter.value === 'all') {
    return currentDocResult.value.issues
  }
  return currentDocResult.value.issues.filter(
    issue => issue.severity === severityFilter.value
  )
})
```

## 审查类别说明

### 1. 法律术语规范性校验
检查文书中法律术语的使用是否规范，如"被告人"与"犯罪嫌疑人"的区分。

### 2. 必填项目完整性检测
检查文书是否包含所有必填项目，如辩护人信息、法律援助说明等。

### 3. 法律引用准确性校验
检查法律条文引用是否准确、完整，是否包含相关司法解释。

### 4. 事实认定证据充分性审查
检查事实认定是否有充分证据支持，事实要素是否完整。

### 5. 证据清单完整性检测
检查证据目录是否完整，是否列明证据来源、页数、证明目的等。

### 6. 程序期限准确性校验
检查拘留、逮捕等程序期限是否符合法律规定。

### 7. 当事人信息准确性校验
检查当事人身份信息是否完整、准确，如身份证号码格式等。

### 8. 量刑情节完整性检测
检查是否说明自首、坦白、从犯等量刑情节。

### 9. 量刑建议缺失
检查是否提出具体的量刑建议。

### 10. 文书格式规范
检查文书格式是否符合规范，如结尾格式、附件清单等。

## 注意事项

1. **审查时间**: 审查过程可能需要较长时间，请耐心等待
2. **网络连接**: 确保网络连接稳定，避免中断
3. **文档格式**: 建议使用 DOCX 格式以获得最佳预览效果
4. **批量审查**: 一次审查多份文档时，时间会相应增加
5. **结果准确性**: AI 审查结果仅供参考，最终以人工审核为准

## 后续优化建议

1. **导出功能**: 实现审查报告的 PDF/Word 导出
2. **历史记录**: 保存审查历史，支持查看和对比
3. **自定义规则**: 允许用户自定义审查规则
4. **批注功能**: 支持在文档上直接批注
5. **修改建议应用**: 一键应用修改建议
6. **审查模板**: 针对不同文书类型提供专门的审查模板
7. **协作审查**: 支持多人协作审查
8. **审查报告分享**: 支持审查报告的分享和讨论

## 相关文件

- `src/views/documents/components/ReviewDialog.vue` - 审查对话框组件
- `src/views/documents/list/index.vue` - 文档列表页面
- `src/api/documents.ts` - API 接口
- `src/types/api/documents.d.ts` - 类型定义
- `DOCX预览功能实现说明.md` - DOCX 预览功能说明
